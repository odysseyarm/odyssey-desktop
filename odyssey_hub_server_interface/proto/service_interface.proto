syntax = "proto3";

package odyssey.service_interface;

service Service {
  // Devices
  rpc GetDeviceList(DeviceListRequest) returns (DeviceListReply) {}
  rpc SubscribeDeviceList(SubscribeDeviceListRequest) returns (stream DeviceListReply) {}

  // Accessories
  rpc GetAccessoryMap(AccessoryMapRequest) returns (AccessoryMapReply) {}
  rpc SubscribeAccessoryMap(SubscribeAccessoryMapRequest) returns (stream AccessoryMapReply) {}
  rpc UpdateAccessoryInfoMap(AccessoryInfoMap) returns (EmptyReply) {}

  // Screen info
  rpc GetScreenInfoById(ScreenInfoByIdRequest) returns (ScreenInfoReply) {}

  rpc SubscribeEvents(SubscribeEventsRequest) returns (stream Event) {}

  // Vendor & zero
  rpc WriteVendor(WriteVendorRequest) returns (EmptyReply) {}
  rpc ReadRegister(ReadRegisterRequest) returns (ReadRegisterReply) {}
  rpc WriteRegister(WriteRegisterRequest) returns (EmptyReply) {}
  rpc FlashSettings(FlashSettingsRequest) returns (EmptyReply) {}
  rpc ClearZero(Device) returns (EmptyReply) {}
  rpc ResetZero(Device) returns (EmptyReply) {}
  rpc SaveZero(Device) returns (EmptyReply) {}
  rpc Zero(ZeroRequest) returns (EmptyReply) {}

  // Shot delay (get + set + save + reset) + subscribe
  rpc ResetShotDelay(Device) returns (ResetShotDelayReply) {}
  rpc GetShotDelay(Device) returns (GetShotDelayReply) {}
  rpc SetShotDelay(SetShotDelayRequest) returns (EmptyReply) {}
  rpc SaveShotDelay(Device) returns (EmptyReply) {}
  rpc SubscribeShotDelay(SubscribeShotDelayRequest) returns (stream GetShotDelayReply) {}

  // Window control
  rpc BringToFront(EmptyRequest) returns (EmptyReply) {}
}

// --- Basic math types ---

message Matrix3x3 {
  float m11 = 1;
  float m12 = 2;
  float m13 = 3;
  float m21 = 4;
  float m22 = 5;
  float m23 = 6;
  float m31 = 7;
  float m32 = 8;
  float m33 = 9;
}

message Matrix3x1 {
  float m11 = 1;
  float m21 = 2;
  float m31 = 3;
}
message Vector2 {
  float x = 1;
  float y = 2;
}
message Vector3 {
  float x = 1;
  float y = 2;
  float z = 3;
}

message Pose {
  Matrix3x3 rotation = 1;
  Matrix3x1 translation = 2;
}

// --- Device ---

enum Transport {
  USB = 0;
  USBMux = 1;
  UDPMux = 2;
}

enum EventsTransport {
  WIRED = 0; // Events transmitted via wired USB
  BLUETOOTH = 1; // Events transmitted via BLE (wireless)
}

message Device {
  bytes uuid = 1;
  Transport transport = 2;
  FirmwareVersion firmware_version = 3; // Optional - check if present before using
  uint32 capabilities = 4; // Bitfield: 0x01 = CONTROL, 0x02 = EVENTS
  EventsTransport events_transport = 5;
  bool events_connected = 6; // Whether events are currently being received
  uint32 product_id = 7; // USB PID (0x520F=AtsVm, 0x5210=AtsLite, 0x5211=Lite1, 0x5212=Mux), 0=unknown
}

message FirmwareVersion {
  uint32 major = 1;
  uint32 minor = 2;
  uint32 patch = 3;
}

// --- Events ---

message DeviceEvent {
  Device device = 1;

  message AccelerometerEvent {
    uint32 timestamp = 1;
    Vector3 acceleration = 2;
    Vector3 angular_velocity = 3;
    Vector3 euler_angles = 4;
  }

  message TrackingEvent {
    uint32 timestamp = 1;
    Vector2 aimpoint = 2;
    Pose pose = 3;
    float distance = 4;
    uint32 screen_id = 5;
  }

  message ImpactEvent {
    uint32 timestamp = 1;
  }

  message PacketEvent {
    bytes bytes = 1;
  }

  message ZeroResultEvent {
    bool success = 1;
  }
  message SaveZeroResultEvent {
    bool success = 1;
  }

  message CapabilitiesChangedEvent {
    // Empty message - device capabilities are in the Device message
  }

  oneof device_event_oneof {
    AccelerometerEvent accelerometer = 2;
    TrackingEvent tracking = 3;
    ImpactEvent impact = 4;
    PacketEvent packet = 7;
    ZeroResultEvent zero_result = 8;
    SaveZeroResultEvent save_zero_result = 9;
    CapabilitiesChangedEvent capabilities_changed = 10;
  }
}

message Event {
  oneof event_oneof {
    DeviceEvent device = 1;
  }
}

// --- Device list ---

message DeviceListRequest {}
message SubscribeDeviceListRequest {}
message DeviceListReply {
  repeated Device device_list = 1;
}

// --- Accessories ---

enum AccessoryType {
  DRY_FIRE_MAG = 0;
  BLACKBEARD_X = 1;
}
enum AccessoryFeature {
  IMPACT = 0;
}

message AccessoryInfo {
  string name = 1;
  AccessoryType ty = 2;
  uint64 assignment = 3; // 0 means None
  repeated AccessoryFeature features = 4;
}

message AccessoryStatus {
  AccessoryInfo accessory = 1;
  bool connected = 2;
}

message AccessoryMapRequest {}
message SubscribeAccessoryMapRequest {}
message AccessoryMapReply {
  map<uint64, AccessoryStatus> accessory_map = 1;
}
message AccessoryInfoMap {
  map<uint64, AccessoryInfo> accessory_info_map = 1;
}

// --- Shot delay ---

message SubscribeShotDelayRequest {
  Device device = 1;
}
message ResetShotDelayReply {
  uint32 delay_ms = 1;
}
message GetShotDelayReply {
  uint32 delay_ms = 1;
}
message SetShotDelayRequest {
  Device device = 1;
  uint32 delay_ms = 2;
}

// --- Screen info ---

message ScreenBounds {
  Vector2 tl = 1;
  Vector2 tr = 2;
  Vector2 bl = 4;
  Vector2 br = 3;
}

message ScreenInfoByIdRequest {
  uint32 id = 1;
}
message ScreenInfoReply {
  uint32 id = 1;
  ScreenBounds bounds = 2;
}

// --- Misc ---

message WriteVendorRequest {
  Device device = 1;
  uint32 tag = 2;
  bytes data = 3;
}

message ZeroRequest {
  Device device = 1;
  Vector3 translation = 2;
  Vector2 target = 3;
  DeviceEvent.TrackingEvent tracking_event = 4;
}

// --- Register / config ---

message ReadRegisterRequest {
  Device device = 1;
  uint32 port = 2; // 0=Nf, 1=Wf
  uint32 bank = 3;
  uint32 address = 4;
}
message ReadRegisterReply {
  uint32 data = 1;
}
message WriteRegisterRequest {
  Device device = 1;
  uint32 port = 2;
  uint32 bank = 3;
  uint32 address = 4;
  uint32 data = 5;
}
message FlashSettingsRequest {
  Device device = 1;
}

message SubscribeEventsRequest {}
message EmptyRequest {}
message EmptyReply {}
