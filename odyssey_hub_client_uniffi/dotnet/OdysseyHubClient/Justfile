set shell := ["powershell.exe", "-c"]

build: build_lib build_projects
run: build run_only

build_lib:
  Write-Host 'OdysseyHubClient' -ForegroundColor Blue;
  Write-Host 'Building native library (Rust)' -ForegroundColor Cyan;
  cargo build --manifest-path=../../Cargo.toml -r;
  cargo run --manifest-path=../../Cargo.toml -r --bin cs_bindgen -- ../../target/release/ohc_uniffi.dll
  cargo build --manifest-path=../../Cargo.toml -r --target=i686-pc-windows-msvc;
  & (Get-Process -Id $PID).Path { \
    $env:CROSS_CONFIG="../../Cross.toml"; \
    cross build --manifest-path=../../Cargo.toml -r --target=x86_64-unknown-linux-gnu; \
    cross build --manifest-path=../../Cargo.toml -r --target=aarch64-unknown-linux-gnu; \
  }

build_projects:
  Write-Host 'Building Radiosity.OdysseyHubClient' -ForegroundColor Cyan;
  dotnet build .\OdysseyHubClient\;
  dotnet pack .\OdysseyHubClient\ -o nugets;

  Write-Host 'Publishing Radiosity.OdysseyHubClient.Test' -ForegroundColor Cyan;
  dotnet build .\OdysseyHubClient.Test\;
  dotnet publish .\OdysseyHubClient.Test\ -o .\output;

  Write-Host 'Running published Radiosity.OdysseyHubClient.Test' -ForegroundColor Cyan;
  Write-Host;

run_only:
  ./output/Radiosity.OdysseyHubClient.Test.exe
